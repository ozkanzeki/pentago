<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merkez Cumhuriyet Ä°lkokulu Pentago Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --p-blue: #0056b3; --p-bg: #f0f2f5; }
        body { background-color: var(--p-bg); font-family: 'Inter', sans-serif; }
        .container { max-width: 700px; }
        .school-header { text-align: center; margin-bottom: 20px; }
        .school-name { font-weight: 800; color: #1e293b; font-size: 1.4rem; text-transform: uppercase; }
        .card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
        .admin-float { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 2000; border: 2px solid var(--p-blue); font-size: 1.2rem;}
        .score-box { width: 55px; height: 40px; text-align: center; border: 2px solid #cbd5e1; border-radius: 8px; font-weight: 800; font-size: 1.1rem; }
        .score-box:focus { border-color: var(--p-blue); outline: none; }
        .match-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 12px; }
        .round-badge { background-color: #1e293b; color: white; padding: 8px; border-radius: 8px; text-align: center; font-weight: 800; margin-top: 25px; margin-bottom: 15px; text-transform: uppercase; }
        #loader { position:fixed; inset:0; background:rgba(255,255,255,0.9); display:none; justify-content:center; align-items:center; z-index:9999; }
        
        /* A4 YazdÄ±rma Optimizasyonu (SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ) */
        @media print { 
            .no-print { display: none !important; } 
            .print-header { display: block !important; text-align: center; margin-bottom: 10px; font-weight: bold; font-size: 1.3rem; }
            .school-header { margin-bottom: 10px !important; }
            .card { box-shadow: none !important; border: 1px solid #ccc !important; padding: 10px !important; margin-bottom: 10px !important; }
            body { background: white; }
            /* Tabloyu Daraltma */
            .table-sm th, .table-sm td { padding: 3px 5px !important; font-size: 11px !important; line-height: 1.1 !important; border-color: #ddd !important; }
            h4 { font-size: 14px !important; margin: 5px 0 !important; }
            .round-badge { background-color: #f8f9fa !important; color: #000 !important; border: 1px solid #000; padding: 4px; margin-top: 10px; margin-bottom: 5px; font-size: 12px;}
            .match-card { page-break-inside: avoid; margin-bottom: 5px !important; padding: 5px !important;}
        }
        .print-header { display: none; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>
<div class="admin-float no-print" onclick="adminLogin()">ğŸ”</div>

<div class="container my-4 px-3">
    
    <div class="print-header">PENTAGO TURNUVASI KATILIMCI LÄ°STESÄ°</div>

    <div class="school-header no-print">
        <div class="school-name">Merkez Cumhuriyet Ä°lkokulu</div>
        <div class="text-primary fw-bold small">ZEKA OYUNLARI BAÅVURU SÄ°STEMÄ°</div>
    </div>

    <div id="registration-page" class="card shadow">
        <div class="p-4 text-center border-bottom bg-white" style="border-top: 5px solid var(--p-blue);">
            <h2 class="fw-bold text-primary m-0">PENTAGO</h2>
            <span class="badge bg-danger p-2 mt-2">ğŸ“… Turnuva Tarihi: 24 ÅUBAT 2026</span>
        </div>
        <div class="p-4">
            <div class="mb-3"><label class="small fw-bold">SÄ±nÄ±f</label><select id="classSelect" class="form-select form-select-lg" onchange="filterStudents()"></select></div>
            <div class="mb-3"><label class="small fw-bold">Ad Soyad</label><select id="studentSelect" class="form-select form-select-lg" disabled onchange="updateNo()"></select></div>
            <div class="mb-3"><label class="small fw-bold">Okul No</label><input type="text" id="stuNo" class="form-control form-control-lg bg-light" readonly></div>
            <div class="mb-4"><label class="small fw-bold">Veli Telefon</label><input type="tel" id="telInput" class="form-control form-control-lg" placeholder="5xx xxx xx xx"></div>
            <div class="alert alert-warning py-2 small fw-bold text-center">âš ï¸ Kuralar iÃ§in ayrÄ±ca liste yayÄ±nlanacak.</div>
            <button class="btn btn-primary btn-lg w-100 fw-bold shadow py-3" onclick="submitRegistration()">KAYDI TAMAMLA</button>
        </div>
    </div>

    <div id="admin-list-page" style="display:none;">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h4 class="fw-bold m-0">KatÄ±lÄ±mcÄ± Listesi</h4>
                <div>
                    <button class="btn btn-dark btn-sm" onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r</button>
                    <button class="btn btn-success btn-sm" onclick="showMatchPage()">âš”ï¸ Turnuva AÄŸacÄ±</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                        <tr><th class="no-print"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th><th>SÄ±ra</th><th>No</th><th>Ad Soyad</th><th>SÄ±nÄ±f</th><th class="no-print">Ä°ÅŸlem</th></tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
            <button class="btn btn-danger btn-sm no-print mt-2" onclick="deleteSelected()">SeÃ§ilenleri Sil</button>
            <button class="btn btn-link btn-sm w-100 mt-3 no-print text-muted" onclick="location.reload()">Forma DÃ¶n</button>
        </div>
    </div>

    <div id="match-page" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <h4 class="fw-bold m-0 text-success">Turnuva AÄŸacÄ±</h4>
            <div class="d-flex gap-1">
                <button class="btn btn-outline-primary btn-sm" onclick="backToList()">â¬… Listeye DÃ¶n</button>
                <button class="btn btn-danger btn-sm" onclick="resetTournament()">ğŸ”„ SÄ±fÄ±rla</button>
            </div>
        </div>

        <div id="tournamentStartContainer" class="text-center my-5 no-print" style="display:none;">
            <button class="btn btn-success btn-lg shadow-lg fw-bold p-4" onclick="generateFullBracket()">ğŸ² KURAYI Ã‡EK VE TURNUVAYI BAÅLAT</button>
            <p class="text-muted mt-2 small">Turnuva bilgisayarÄ±n hafÄ±zasÄ±na kaydedilecektir.</p>
        </div>

        <div id="championArea"></div>
        <div id="bracketArea"></div>

        <button id="finalPrintBtn" class="btn btn-dark w-100 mt-4 no-print shadow" onclick="window.print()" style="display:none;">ğŸ–¨ï¸ Mevcut Tabloyu YazdÄ±r</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcvqxOP2ahEdhqRPLtc0lmvwFH8bpbrjgZPKdZ41DRaay28XnMHTJnFm2-FjhhKAuY/exec";
    let allStudents = [], registrations = [];
    let bracketData = null; // TÃ¼m turnuva aÄŸacÄ±nÄ± tutan deÄŸiÅŸken

    window.onload = () => {
        setLoader(true);
        fetch(SCRIPT_URL).then(r => r.json()).then(data => {
            allStudents = data;
            const blocked = ["HAFÄ°F ZÄ°HÄ°NSEL", "OTÄ°STÄ°K", "Ã–ZEL EÄÄ°TÄ°M"];
            const classes = [...new Set(data.map(s => s.sinif))].sort().filter(c => {
                return !blocked.some(b => c.toUpperCase().includes(b));
            });
            const classSel = document.getElementById('classSelect');
            classSel.innerHTML = '<option value="">SÄ±nÄ±f SeÃ§iniz...</option>';
            classes.forEach(c => classSel.innerHTML += `<option value="${c}">${c}</option>`);
        }).finally(() => setLoader(false));
    };

    function filterStudents() {
        const cls = document.getElementById('classSelect').value;
        const stuSel = document.getElementById('studentSelect');
        stuSel.innerHTML = '<option value="">Ä°sim SeÃ§iniz...</option>';
        if(cls) {
            allStudents.filter(s => s.sinif == cls).forEach(s => {
                stuSel.innerHTML += `<option value="${s.adSoyad}" data-no="${s.no}">${s.adSoyad}</option>`;
            });
            stuSel.disabled = false;
        }
    }

    function updateNo() {
        const sel = document.getElementById('studentSelect');
        document.getElementById('stuNo').value = sel.options[sel.selectedIndex].dataset.no || "";
    }

    async function submitRegistration() {
        const ad = document.getElementById('studentSelect').value;
        const no = document.getElementById('stuNo').value;
        const tel = document.getElementById('telInput').value;
        if(!ad || tel.length < 10) return alert("Bilgileri kontrol edin!");

        setLoader(true);
        const resp = await fetch(SCRIPT_URL + "?type=getRegistrations");
        const existingData = await resp.json();
        if(existingData.some(r => r[1].toString() === no.toString())) {
            setLoader(false);
            return alert("KaydÄ±nÄ±z daha Ã¶nce alÄ±ndÄ±. Rehber Ã¶ÄŸretmenle iletiÅŸime geÃ§iniz.");
        }

        fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ 
            adSoyad: ad, sinif: document.getElementById('classSelect').value,
            no: no, oyunlar: "Pentago", tel: tel 
        })}).then(() => { 
            setLoader(false);
            alert("KaydÄ±nÄ±z alÄ±ndÄ±, teÅŸekkÃ¼rler!"); 
            location.reload(); 
        });
    }

    function adminLogin() { if(prompt("Åifre:") === "04051257") showAdminList(); }

    function showAdminList() {
        setLoader(true);
        document.getElementById('registration-page').style.display = 'none';
        document.getElementById('match-page').style.display = 'none';
        document.getElementById('admin-list-page').style.display = 'block';
        fetch(SCRIPT_URL + "?type=getRegistrations").then(r => r.json()).then(data => {
            registrations = data;
            const body = document.getElementById('adminTableBody');
            body.innerHTML = "";
            data.forEach((r, i) => { 
                body.innerHTML += `<tr><td class="no-print"><input type="checkbox" class="del-check" value="${r[1]}"></td><td><b>${i+1}</b></td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td class="no-print"><button class="btn btn-sm text-danger" onclick="deleteSingle('${r[1]}')">Sil</button></td></tr>`; 
            });
        }).finally(() => setLoader(false));
    }

    function backToList() {
        document.getElementById('match-page').style.display = 'none';
        document.getElementById('admin-list-page').style.display = 'block';
    }

    // --- TURNUVA AÄACI MANTIÄI (HAFIZALI) ---
    function showMatchPage() {
        document.getElementById('admin-list-page').style.display = 'none';
        document.getElementById('match-page').style.display = 'block';
        
        // TarayÄ±cÄ± hafÄ±zasÄ±nÄ± kontrol et
        const savedBracket = localStorage.getItem('pentagoBracketData');
        
        if(savedBracket) {
            bracketData = JSON.parse(savedBracket);
            document.getElementById('tournamentStartContainer').style.display = 'none';
            document.getElementById('finalPrintBtn').style.display = 'block';
            renderBracket();
        } else {
            document.getElementById('tournamentStartContainer').style.display = 'block';
            document.getElementById('bracketArea').innerHTML = "";
            document.getElementById('championArea').innerHTML = "";
            document.getElementById('finalPrintBtn').style.display = 'none';
        }
    }

    function generateFullBracket() {
        if(registrations.length < 2) return alert("Yeterli katÄ±lÄ±mcÄ± yok!");
        
        let players = registrations.map(r => ({n: r[2], c: r[3]}));
        players.sort(() => Math.random() - 0.5); // KarÄ±ÅŸtÄ±r

        bracketData = [];
        let round0 = [];
        
        // Ä°lk tur eÅŸleÅŸmeleri (EÄŸer tek ise son kiÅŸi BAY geÃ§er)
        for(let i=0; i < players.length; i+=2) {
            if(players[i+1]) {
                round0.push({ p1: [players[i]], p2: [players[i+1]], s1: null, s2: null, completed: false, isBye: false, winners: [] });
            } else {
                round0.push({ p1: [players[i]], p2: [], s1: null, s2: null, completed: true, isBye: true, winners: [players[i]] });
            }
        }
        bracketData.push(round0);

        // BoÅŸ yuvalarla (bekleyen koltuklar) finale kadar olan aÄŸacÄ± oluÅŸtur
        let currentRoundMatches = round0.length;
        while(currentRoundMatches > 1) {
            let nextRoundMatches = Math.ceil(currentRoundMatches / 2);
            let nextRound = [];
            for(let i=0; i < nextRoundMatches; i++) {
                nextRound.push({ p1: [], p2: [], s1: null, s2: null, completed: false, isBye: false, winners: [] });
            }
            bracketData.push(nextRound);
            currentRoundMatches = nextRoundMatches;
        }

        // Ä°lk turdaki BAY geÃ§enleri hemen 2. tura (varsa) aktar
        bracketData[0].forEach((m, idx) => {
            if(m.isBye) advancePlayer(0, idx, m.winners);
        });

        saveAndRender();
        document.getElementById('tournamentStartContainer').style.display = 'none';
        document.getElementById('finalPrintBtn').style.display = 'block';
    }

    function advancePlayer(rIndex, mIndex, winners) {
        if (rIndex + 1 >= bracketData.length) return; // Final bitti
        
        let nextMatchIndex = Math.floor(mIndex / 2);
        let isPlayer1 = (mIndex % 2 === 0);
        let nextMatch = bracketData[rIndex + 1][nextMatchIndex];

        if(isPlayer1) nextMatch.p1 = winners;
        else nextMatch.p2 = winners;

        // EÄŸer bu sonraki maÃ§Ä±n sadece 1 besleyicisi varsa (tek kaldÄ±ysa) otomatik BAY geÃ§er
        let totalFeedersForNextMatch = 0;
        if(bracketData[rIndex].length > nextMatchIndex * 2) totalFeedersForNextMatch++;
        if(bracketData[rIndex].length > nextMatchIndex * 2 + 1) totalFeedersForNextMatch++;

        if(totalFeedersForNextMatch === 1 && nextMatch.p1.length > 0) {
            nextMatch.isBye = true;
            nextMatch.completed = true;
            nextMatch.winners = nextMatch.p1;
            advancePlayer(rIndex + 1, nextMatchIndex, nextMatch.winners);
        }
    }

    function saveMatchScore(rIndex, mIndex) {
        const match = bracketData[rIndex][mIndex];
        const vA = parseInt(document.getElementById(`sA_${rIndex}_${mIndex}`).value);
        const vB = parseInt(document.getElementById(`sB_${rIndex}_${mIndex}`).value);

        if(isNaN(vA) || isNaN(vB) || vA < 0 || vA > 3 || vB < 0 || vB > 3) {
            return alert("Skorlar 0 ile 3 arasÄ±nda olmalÄ±dÄ±r!");
        }

        match.s1 = vA;
        match.s2 = vB;
        match.completed = true;

        // KazanÄ±nÄ± belirle (Beraberlik durumunda ikisi de Ã§Ä±kar)
        if(vA > vB) match.winners = [...match.p1];
        else if(vB > vA) match.winners = [...match.p2];
        else match.winners = [...match.p1, ...match.p2]; // BERABERLÄ°K

        advancePlayer(rIndex, mIndex, match.winners);
        saveAndRender();
    }

    function saveAndRender() {
        localStorage.setItem('pentagoBracketData', JSON.stringify(bracketData));
        renderBracket();
    }

    function getNames(playerArray) {
        if(!playerArray || playerArray.length === 0) return "";
        return playerArray.map(p => p.n).join(' & '); // Beraberlikte isimleri & ile birleÅŸtirir
    }

    function renderBracket() {
        let html = "";
        let finalMatch = bracketData[bracketData.length - 1][0];

        if(finalMatch && finalMatch.completed && !finalMatch.isBye) {
            document.getElementById('championArea').innerHTML = `
            <div class="card p-4 text-center shadow border-success mb-4 bg-success text-white">
                <h1 class="display-1 m-0">ğŸ†</h1>
                <h3 class="fw-bold m-0 mt-2">ÅAMPÄ°YON</h3>
                <h2 class="fw-bold">${getNames(finalMatch.winners)}</h2>
            </div>`;
        } else {
            document.getElementById('championArea').innerHTML = "";
        }

        bracketData.forEach((round, rIndex) => {
            let roundName = (rIndex + 1) + ". TUR";
            if(bracketData.length > 1) {
                if(rIndex === bracketData.length - 1) roundName = "FÄ°NAL";
                else if(rIndex === bracketData.length - 2) roundName = "YARI FÄ°NAL";
                else if(rIndex === bracketData.length - 3) roundName = "Ã‡EYREK FÄ°NAL";
            }

            html += `<div class="round-badge">${roundName}</div>`;
            
            round.forEach((m, mIndex) => {
                if(m.isBye) {
                    html += `<div class="p-2 bg-light rounded mb-2 border-start border-warning border-4 small fw-bold text-warning shadow-sm">âœ¨ ${getNames(m.p1)} (BAY GEÃ‡TÄ°)</div>`;
                    return;
                }

                let p1Ready = m.p1 && m.p1.length > 0;
                let p2Ready = m.p2 && m.p2.length > 0;
                let bothReady = p1Ready && p2Ready;

                let p1NameHTML = p1Ready ? `<span class="fw-bold">${getNames(m.p1)}</span>` : `<span class="text-muted small">â³ Alt turdan rakip bekleniyor...</span>`;
                let p2NameHTML = p2Ready ? `<span class="fw-bold">${getNames(m.p2)}</span>` : `<span class="text-muted small">â³ Alt turdan rakip bekleniyor...</span>`;

                if(m.completed) {
                    let resultText = "";
                    if(m.s1 > m.s2) resultText = `Kazanan: <span class="text-success">${getNames(m.p1)}</span>`;
                    else if(m.s2 > m.s1) resultText = `Kazanan: <span class="text-success">${getNames(m.p2)}</span>`;
                    else resultText = `<span class="text-warning">Berabere (Ä°kisi de Ã§Ä±ktÄ±)</span>`;

                    html += `<div class="match-card p-3 shadow-sm" style="background-color: #f8fafc; border-color: #cbd5e1; opacity: 0.85;">
                        <div class="d-flex justify-content-between mb-2"><span>${p1NameHTML}</span> <span class="badge bg-secondary fs-6">${m.s1}</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>${p2NameHTML}</span> <span class="badge bg-secondary fs-6">${m.s2}</span></div>
                        <div class="small text-center fw-bold border-top pt-2 mt-2">${resultText}</div>
                    </div>`;
                } else {
                    html += `<div class="match-card p-3 shadow-sm border-start border-primary border-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            ${p1NameHTML}
                            <input type="number" id="sA_${rIndex}_${mIndex}" class="score-box" min="0" max="3" ${!bothReady ? 'disabled' : ''}>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            ${p2NameHTML}
                            <input type="number" id="sB_${rIndex}_${mIndex}" class="score-box" min="0" max="3" ${!bothReady ? 'disabled' : ''}>
                        </div>
                        ${bothReady ? `<button class="btn btn-primary btn-sm w-100 mt-2 fw-bold" onclick="saveMatchScore(${rIndex}, ${mIndex})">Skoru Kaydet ve Ãœst Tura GÃ¶nder</button>` : `<button class="btn btn-secondary btn-sm w-100 mt-2 opacity-50" disabled>Rakiplerin Belli OlmasÄ± Bekleniyor</button>`}
                    </div>`;
                }
            });
        });

        document.getElementById('bracketArea').innerHTML = html;
    }

    function resetTournament() {
        if(confirm("DÄ°KKAT! BaÅŸlamÄ±ÅŸ olan turnuvanÄ±n tÃ¼m eÅŸleÅŸmeleri ve skorlarÄ± SÄ°LÄ°NECEK. Devam edilsin mi?")) {
            localStorage.removeItem('pentagoBracketData');
            bracketData = null;
            showMatchPage();
        }
    }
    
    function setLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function toggleSelectAll() {
        const master = document.getElementById('selectAll');
        document.querySelectorAll('.del-check').forEach(c => c.checked = master.checked);
    }
    function deleteSingle(id) { if(confirm("KaydÄ± silmek istiyor musunuz?")) sendDelete([id]); }
    function deleteSelected() {
        const ids = [...document.querySelectorAll('.del-check:checked')].map(c => c.value);
        if(ids.length === 0) return alert("SeÃ§im yapmadÄ±nÄ±z.");
        if(confirm(ids.length + " kayÄ±t silinecek. Emin misiniz?")) sendDelete(ids);
    }
    function sendDelete(ids) {
        setLoader(true);
        fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", ids: ids }) })
        .then(() => { showAdminList(); });
    }
</script>
</body>
</html>
