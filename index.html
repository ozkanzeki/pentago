<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merkez Cumhuriyet Ä°lkokulu Pentago Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --p-blue: #0056b3; --p-bg: #f0f2f5; }
        body { background-color: var(--p-bg); font-family: 'Inter', sans-serif; }
        .container { max-width: 700px; }
        .school-header { text-align: center; margin-bottom: 20px; }
        .school-name { font-weight: 800; color: #1e293b; font-size: 1.4rem; text-transform: uppercase; }
        .card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
        .admin-float { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 2000; border: 2px solid var(--p-blue); }
        .score-box { width: 60px; height: 45px; text-align: center; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 800; font-size: 1.2rem; }
        .match-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; }
        #loader { position:fixed; inset:0; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; }
        
        @media print { 
            .no-print { display: none !important; } 
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 1.6rem; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            body { background: white; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary"></div></div>
<div class="admin-float no-print" onclick="adminLogin()">ğŸ”</div>

<div class="container my-4 px-3">
    
    <div class="print-header">PENTAGO TURNUVASI KATILIMCI LÄ°STESÄ°</div>

    <div class="school-header no-print">
        <div class="school-name">Merkez Cumhuriyet Ä°lkokulu</div>
        <div class="text-primary fw-bold small">ZEKA OYUNLARI BAÅVURU SÄ°STEMÄ°</div>
    </div>

    <div id="registration-page" class="card shadow">
        <div class="game-header p-4 text-center border-bottom bg-white">
            <h2 class="fw-bold text-primary m-0">PENTAGO</h2>
            <span class="badge bg-danger p-2">ğŸ“… Turnuva Tarihi: 24 ÅUBAT 2026</span>
        </div>
        <div class="p-4">
            <div class="mb-3"><label class="small fw-bold">SÄ±nÄ±f</label><select id="classSelect" class="form-select form-select-lg" onchange="filterStudents()"></select></div>
            <div class="mb-3"><label class="small fw-bold">Ad Soyad</label><select id="studentSelect" class="form-select form-select-lg" disabled onchange="updateNo()"></select></div>
            <div class="mb-3"><label class="small fw-bold">Okul No</label><input type="text" id="stuNo" class="form-control form-control-lg bg-light" readonly></div>
            <div class="mb-4"><label class="small fw-bold">Veli Telefon</label><input type="tel" id="telInput" class="form-control form-control-lg" placeholder="5xx xxx xx xx"></div>
            <div class="alert alert-warning py-2 small fw-bold text-center">âš ï¸ Kuralar iÃ§in ayrÄ±ca liste yayÄ±nlanacak.</div>
            <button class="btn btn-primary btn-lg w-100 fw-bold shadow py-3" onclick="submitRegistration()">KAYDI TAMAMLA</button>
        </div>
    </div>

    <div id="admin-list-page" style="display:none;">
        <div class="card p-4">
            <div class="d-flex justify-content-between mb-3 no-print">
                <h4 class="fw-bold m-0">KatÄ±lÄ±mcÄ± Listesi</h4>
                <div>
                    <button class="btn btn-dark btn-sm" onclick="window.print()">ğŸ–¨ï¸ Listeyi YazdÄ±r</button>
                    <button class="btn btn-success btn-sm" onclick="showMatchPage()">âš”ï¸ EÅŸleÅŸtirmelere GeÃ§</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle small">
                    <thead class="table-light">
                        <tr><th class="no-print"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th><th>SÄ±ra</th><th>No</th><th>Ad Soyad</th><th>SÄ±nÄ±f</th><th class="no-print">Ä°ÅŸlem</th></tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
            <button class="btn btn-danger btn-sm no-print mt-2" onclick="deleteSelected()">SeÃ§ilenleri Sil</button>
            <button class="btn btn-link btn-sm w-100 mt-3 no-print text-muted" onclick="location.reload()">Forma DÃ¶n</button>
        </div>
    </div>

    <div id="match-page" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <h4 class="fw-bold m-0 text-success">Turnuva AkÄ±ÅŸÄ±</h4>
            <div class="d-flex gap-1">
                <button class="btn btn-outline-primary btn-sm" onclick="backToList()">â¬… Listeye DÃ¶n</button>
                <button class="btn btn-danger btn-sm" onclick="resetTournament()">ğŸ”„ SÄ±fÄ±rla</button>
            </div>
        </div>
        <div id="tournamentHistory"></div>
        <div id="currentRoundArea"></div>
        <div id="tournamentActions" class="mt-4 no-print" style="display:none;">
            <button class="btn btn-success btn-lg w-100 fw-bold shadow" onclick="nextRound()">TURU TAMAMLA â®•</button>
        </div>
        <button id="finalPrintBtn" class="btn btn-dark w-100 mt-4 no-print" onclick="window.print()" style="display:none;">ğŸ–¨ï¸ Durumu YazdÄ±r</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyoLgdC6oFusw3w7O1rnscqreCC3cLdZviNuApV2YOHYABuggNN-ViAAQiBHAStBQWH/exec";
    let allStudents = [], registrations = [], currentPlayers = [], roundCount = 1;

    // Sayfa yÃ¼klendiÄŸinde sÄ±nÄ±flarÄ± doldurur
window.onload = () => {
    setLoader(true);
    fetch(SCRIPT_URL).then(r => r.json()).then(data => {
        allStudents = data; // Bu veri artÄ±k sadece 'blocked' olmayan Ã¶ÄŸrencileri iÃ§eriyor
        
        // SÄ±nÄ±f listesini benzersiz olarak al
        const classes = [...new Set(data.map(s => s.sinif))].sort();
        const classSel = document.getElementById('classSelect');
        classSel.innerHTML = '<option value="">SÄ±nÄ±f SeÃ§iniz...</option>';
        classes.forEach(c => {
            if(c) classSel.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }).finally(() => setLoader(false));
};

function filterStudents() {
    const cls = document.getElementById('classSelect').value;
    const stuSel = document.getElementById('studentSelect');
    stuSel.innerHTML = '<option value="">Ä°sim SeÃ§iniz...</option>';
    if(cls) {
        // SeÃ§ilen sÄ±nÄ±fa gÃ¶re Ã¶ÄŸrencileri filtrele
        allStudents.filter(s => s.sinif == cls).forEach(s => {
            stuSel.innerHTML += `<option value="${s.adSoyad}" data-no="${s.no}">${s.adSoyad}</option>`;
        });
        stuSel.disabled = false;
    }
}

    function updateNo() {
        const sel = document.getElementById('studentSelect');
        document.getElementById('stuNo').value = sel.options[sel.selectedIndex].dataset.no || "";
    }

    async function submitRegistration() {
        const ad = document.getElementById('studentSelect').value;
        const no = document.getElementById('stuNo').value;
        const tel = document.getElementById('telInput').value;
        if(!ad || tel.length < 10) return alert("Bilgileri kontrol edin!");

        setLoader(true);
        const resp = await fetch(SCRIPT_URL + "?type=getRegistrations");
        const existingData = await resp.json();
        if(existingData.some(r => r[1].toString() === no.toString())) {
            setLoader(false);
            return alert("KaydÄ±nÄ±z daha Ã¶nce alÄ±ndÄ±. Rehber Ã¶ÄŸretmenle iletiÅŸime geÃ§iniz.");
        }

        fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ 
            adSoyad: ad, sinif: document.getElementById('classSelect').value,
            no: no, oyunlar: "Pentago", tel: tel 
        })}).then(() => { 
            setLoader(false);
            alert("KaydÄ±nÄ±z alÄ±ndÄ±, teÅŸekkÃ¼rler!"); 
            location.reload(); 
        });
    }

    function adminLogin() { if(prompt("Åifre:") === "04051257") showAdminList(); }

    function showAdminList() {
        setLoader(true);
        document.getElementById('registration-page').style.display = 'none';
        document.getElementById('match-page').style.display = 'none';
        document.getElementById('admin-list-page').style.display = 'block';
        fetch(SCRIPT_URL + "?type=getRegistrations").then(r => r.json()).then(data => {
            registrations = data;
            const body = document.getElementById('adminTableBody');
            body.innerHTML = "";
            data.forEach((r, i) => { 
                body.innerHTML += `<tr><td class="no-print"><input type="checkbox" class="del-check" value="${r[1]}"></td><td><b>${i+1}</b></td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td class="no-print"><button class="btn btn-sm text-danger" onclick="deleteSingle('${r[1]}')">Sil</button></td></tr>`; 
            });
        }).finally(() => setLoader(false));
    }

    function backToList() {
        document.getElementById('match-page').style.display = 'none';
        document.getElementById('admin-list-page').style.display = 'block';
    }

    function showMatchPage() {
        document.getElementById('admin-list-page').style.display = 'none';
        document.getElementById('match-page').style.display = 'block';
        document.getElementById('finalPrintBtn').style.display = 'block';
        if(currentPlayers.length === 0) {
            currentPlayers = registrations.map(r => ({n: r[2], c: r[3]}));
            renderMatches();
        }
    }

    function renderMatches() {
        currentPlayers.sort(() => Math.random() - 0.5);
        const area = document.getElementById('currentRoundArea');
        const actions = document.getElementById('tournamentActions');
        
        if(currentPlayers.length === 1) {
            area.innerHTML = `<div class="card p-5 text-center shadow border-success"><h1 class="display-1">ğŸ†</h1><h3>ÅAMPÄ°YON: ${currentPlayers[0].n}</h3></div>`;
            actions.style.display = 'none';
            return;
        }

        let html = `<div class="bg-primary text-white p-2 rounded mb-3 fw-bold">${roundCount}. TUR EÅLEÅMELERÄ°</div>`;
        for(let i=0; i<currentPlayers.length; i+=2) {
            if(currentPlayers[i+1]) {
                html += `<div class="match-card p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-2"><span>${currentPlayers[i].n}</span><input type="number" class="score-box s-a" min="0" max="3"></div>
                    <div class="d-flex justify-content-between align-items-center"><span>${currentPlayers[i+1].n}</span><input type="number" class="score-box s-b" min="0" max="3"></div>
                </div>`;
            } else {
                html += `<div class="p-3 bg-light rounded mb-2 border-start border-warning border-4 fw-bold text-warning">âœ¨ ${currentPlayers[i].n} (BAY)</div>`;
            }
        }
        area.innerHTML = html;
        actions.style.display = 'block';
    }

    function nextRound() {
        const sA = document.querySelectorAll('.s-a'), sB = document.querySelectorAll('.s-b');
        let winners = [], error = false;
        let roundRes = `<div class="fw-bold small mb-2 text-primary border-bottom">${roundCount}. Tur SonuÃ§larÄ±:</div>`;

        sA.forEach((s, i) => {
            const vA = parseInt(s.value), vB = parseInt(sB[i].value);
            if(isNaN(vA) || isNaN(vB) || vA<0 || vA>3 || vB<0 || vB>3) { error = true; return; }
            let win = vA > vB ? currentPlayers[i*2] : currentPlayers[i*2+1];
            winners.push(win);
            roundRes += `<div class="small p-1 border-bottom text-muted">${currentPlayers[i*2].n} (${vA}) - (${vB}) ${currentPlayers[i*2+1].n} â®• Kazanan: ${win.n}</div>`;
        });

        if(error) return alert("Skorlar 0-3 arasÄ± olmalÄ±!");
        document.getElementById('tournamentHistory').innerHTML += `<div class="mb-3 bg-white p-3 rounded shadow-sm border opacity-75">${roundRes}</div>`;
        if(currentPlayers.length % 2 !== 0) winners.push(currentPlayers[currentPlayers.length-1]);
        currentPlayers = winners; roundCount++; renderMatches();
    }
function deleteSingle(id) {
    if(confirm("Bu kaydÄ± silmek istediÄŸinize emin misiniz?")) {
        sendDelete([id]);
    }
}

function deleteSelected() {
    const ids = [...document.querySelectorAll('.del-check:checked')].map(c => c.value);
    if(ids.length === 0) return alert("LÃ¼tfen silinecek Ã¶ÄŸrencileri seÃ§in.");
    if(confirm(ids.length + " Ã¶ÄŸrenciyi silmek istediÄŸinize emin misiniz?")) {
        sendDelete(ids);
    }
}

function sendDelete(ids) {
    setLoader(true);
    fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({ action: "delete", ids: ids })
    }).then(() => {
        alert("SeÃ§ilen kayÄ±tlar baÅŸarÄ±yla silindi.");
        showAdminList(); // Listeyi yenile
    }).catch(err => alert("Hata: " + err))
      .finally(() => setLoader(false));
}

function toggleSelectAll() {
    const master = document.getElementById('selectAll');
    document.querySelectorAll('.del-check').forEach(c => c.checked = master.checked);
}
    function resetTournament() {
        if(confirm("TÃ¼m sÃ¼reÃ§ sÄ±fÄ±rlanacak. Emin misiniz?")) {
            roundCount = 1; document.getElementById('tournamentHistory').innerHTML = "";
            currentPlayers = registrations.map(r => ({n: r[2], c: r[3]})); renderMatches();
        }
    }
    
    function setLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function toggleSelectAll() {
        const master = document.getElementById('selectAll');
        document.querySelectorAll('.del-check').forEach(c => c.checked = master.checked);
    }
    // Delete functions remains the same...
</script>
</body>
</html>
